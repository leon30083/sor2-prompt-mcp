# 开发日志（2025-11-11）

## 概述
今天完成了用户样式映射层与自动化测试落地，统一了分段与时长策略：默认每段 12 秒，强制不超过 15 秒。新增一键测试脚本，并将 MCP 服务器工具描述更新为“默认 12，最大 15”。

## 改动列表
- 新增用户样式映射：`src/user_style_adapter.py`
- 生成函数支持用户样式输出：`generate_user_style_model`（`src/mcp_tool.py`）
- MCP 服务器添加新工具：NDJSON `/sora2/agent.generate.user_style` 与 JSON-RPC `sora2.agent.generate.user_style`（`src/mcp_server.py`）
- 默认时长调整：镜头默认秒数 `default_seconds` 改为 3，分段目标时长 `segment_seconds` 默认 12，且强制上限 15（`src/mcp_tool.py`）
- 在 `meta.segments` 中新增 `total_duration` 字段，表示每分段镜头秒数总和（`src/mcp_tool.py`），便于测试校验每分段总时长与目标一致且不超过 15 秒。
- 更新工具描述文案：所有工具的 `segment_seconds` 字段描述改为“默认 12，最大 15”（`src/mcp_server.py`）
- 添加包初始化文件：`src/__init__.py`，使 pytest 可按包路径导入。
- 添加 pytest 配置：`tests/conftest.py`，确保 `src.*` 可被导入。
- 新增 10 条自动化测试：`tests/test_user_style_cases.py`（13/13 通过）。
- 新增一键测试脚本：`scripts/run_tests.ps1`（Windows PowerShell）。

## 接口与参数
新增接口：
- NDJSON：`/sora2/agent.generate.user_style`
- JSON-RPC：`name = "sora2.agent.generate.user_style"`

输入参数（与原生成接口一致）：
- text: 中文剧本文本（必填）
- default_seconds: 每镜头默认时长（字符串，默认 3）
- narration_limit: 旁白镜头数量上限（默认 3）
- mode: 解析模式，auto|narration
- composition_policy: 构图偏好，neutral|mono|mono_or_empty
- format: 是否格式化分段（默认 true）
- segment_seconds: 每段目标总时长（默认 12，最大 15）
- time_fit_strategy: 时长对齐策略，scale|pad|trim（默认 scale）

输出字段采用用户示例样式：
- shots_list: 镜头数组
  - shot_id, shot_type, duration, frame_content, sound_effect, line, camera_movement
- shots_count: 镜头数量
- total_duration: 所有镜头时长总和（整数秒）
- meta: 解析元数据（包含每分段 `title`、`shots_count`、`total_duration`）

## 分段与时长规则说明
- 分段：
  - 若文本包含以 `###` 开头的标题，按标题分段；
  - 否则按空行分段；若为空也会生成占位标题（片段1）。
- 时长：
  - 默认每分段目标 12 秒（避免溢出、便于合成与过渡），且强制不超过 15 秒；
  - 对齐策略：
    - scale：按比例缩放直至精确匹配目标（考虑整数四舍五入修正）；
    - pad：不足则均匀填充至目标；
    - trim：超出则按比例缩减且不低于 1 秒；若本身不足目标，则保持不扩展，仅保证不超过目标。

## 测试
运行：
```
python -m pytest -q
```
或一键：
```
./scripts/run_tests.ps1
```
结果：当前 13/13 全部通过。

## 使用示例
JSON-RPC 调用示例（伪）：
```
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "sora2.agent.generate.user_style",
    "arguments": {
      "text": "### 开场\n风声呼啸……",
      "format": true,
      "segment_seconds": 12,
      "time_fit_strategy": "scale"
    }
  }
}
```

## 下一步建议
- 如需与旧版“剧本模型示例”进一步字段对齐，可扩展映射（例如将 cinematography 拆分到 `shot_type` 与 `camera_movement`）——当前已支持。
- 若需导出 NDJSON 或批量生成报告，可添加批处理脚本。

## 推送说明
已存在远程：`origin https://github.com/leon30083/sor2-prompt-mcp.git`
建议推送前确保代理（Clash for Windows）已启用，并设置 Git 代理：
```
git config --global http.proxy http://127.0.0.1:7890
git config --global https.proxy http://127.0.0.1:7890
```
推送命令：
```
git add -A
git commit -m "feat: user_style 映射层与测试；segment_seconds 默认 12/上限 15；meta.segments.total_duration；13/13 tests"
git push origin HEAD
```